From 8ac04528f1bf17107caaf8ef5d5fc104c934272f Mon Sep 17 00:00:00 2001
From: Klaus Zimmermann <klaus.zimmermann@smhi.se>
Date: Mon, 6 Jun 2022 15:16:34 +0200
Subject: [PATCH 4/4] Try to add vendored MINIZIP and URIPARSER to libkml
 handling

---
 cmake/modules/packages/FindLibKML.cmake | 18 ++++++++++++++++++
 ogr/ogrsf_frmts/libkml/CMakeLists.txt   |  2 +-
 2 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/cmake/modules/packages/FindLibKML.cmake b/cmake/modules/packages/FindLibKML.cmake
index e4367f5d1b..6b42cd3a8b 100644
--- a/cmake/modules/packages/FindLibKML.cmake
+++ b/cmake/modules/packages/FindLibKML.cmake
@@ -67,6 +67,15 @@ foreach(_comp IN LISTS libkml_known_components)
   endif()
 endforeach()
 
+set(libkml_helpers MINIZIP URIPARSER)
+foreach(_helper IN LISTS libkml_helpers)
+  string(TOLOWER ${_helper} _name)
+  find_library(LIBKML_${_helper}_LIBRARY
+               NAMES ${_name} lib${_name}
+               HINTS ${PC_LIBKML_LIBRARY_DIRS} )
+  mark_as_advanced(LIBKML_${_helper}_LIBRARY)
+endforeach()
+
 if(LIBKML_INCLUDE_DIR AND NOT LIBKML_VERSION)
   file(STRINGS ${LIBKML_INCLUDE_DIR}/kml/base/version.h libkml_version_h_string
        REGEX "^#define[\t ]+LIBKML_(MAJOR|MINOR|MICRO)_VERSION[\t ]+[0-9]+")
@@ -108,4 +117,13 @@ if(LIBKML_FOUND)
       endif()
     endif()
   endforeach()
+  foreach(_helper IN LISTS libkml_helpers)
+      list(APPEND LIBKML_LIBRARIES "${LIBKML_${_helper}_LIBRARY}")
+      if(NOT TARGET LIBKML::${_helper})
+        add_library(LIBKML::${_helper} UNKNOWN IMPORTED)
+        set_target_properties(LIBKML::${_helper} PROPERTIES
+                              IMPORTED_LINK_INTERFACE_LANGUAGES "C++"
+                              IMPORTED_LOCATION "${LIBKML_${_helper}_LIBRARY}")
+      endif()
+  endforeach()
 endif()
diff --git a/ogr/ogrsf_frmts/libkml/CMakeLists.txt b/ogr/ogrsf_frmts/libkml/CMakeLists.txt
index 401628916a..e2a11f5592 100644
--- a/ogr/ogrsf_frmts/libkml/CMakeLists.txt
+++ b/ogr/ogrsf_frmts/libkml/CMakeLists.txt
@@ -17,4 +17,4 @@ add_gdal_driver(
           ogrlibkmlfield.cpp
           PLUGIN_CAPABLE)
 gdal_standard_includes(ogr_LIBKML)
-gdal_target_link_libraries(ogr_LIBKML PRIVATE LIBKML::LibKML LIBKML::DOM LIBKML::ENGINE)
+gdal_target_link_libraries(ogr_LIBKML PRIVATE LIBKML::LibKML LIBKML::DOM LIBKML::ENGINE LIBKML::MINIZIP LIBKML::URIPARSER)
-- 
2.35.1

